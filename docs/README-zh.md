# selfweb3

[简体中文][1]

### 一种为链上高度安全和数据所有权提供私有化保障的web3解决方案，通过强制动态授权，将用户资产一对一绑定到自己，而非钱包，零知识证明 + webAuthn + TOTP + 关联验证

![/docs/selfweb3.png](/docs/selfweb3.png)

## 合约

1. **Arbitrum Goerli, 421613: 0x7B6E05a55B1756f827F205BF454BF75288904ecF**

## 系统架构

### 原则: web3合约、wasm部分和web2服务各自负责具体任务，三方相互制约, 保证去中心化运作的同时, 提供高度安全的隐私保护

![/docs/selfweb3-arch.png](/docs/selfweb3-arch.png)

#### 说明: 公私钥指椭圆曲线secp256k1生成的公私钥对，密钥指32位明文字符串，dhKey指通过私钥和公钥动态计算出来的共享密钥

> - 合约: 去中心化存储，一经注册写入，无法更改，支持钱包重新绑定，依赖于用户私有动态授权，而非钱包公私钥

> - wasm: 提供密钥合成、TOTP校验和邮件校验服务，支持关联验证机制的链下实现，所有操作需要依赖wasm密文已解密

> - 后端: web2服务, 提供web2请求转发, 关联性管理以及加密数据存储和提取等定向增值服务, 无会话，无状态，仅处理密文数据

> - TOTP: 由web2服务提供TOTP密钥密文, web3合约提供web3公钥密文，wasm部分计算和解密出TOTP密钥后进行动态验证

> - WebAuthn: 由web2服务提供WebAuthn密钥密文, web3合约提供web3密钥密文, wasm部分解密后由web2服务完成授权校验

> - 邮件: 由wasm部分负责缓存动态验证码并完成验证, web2服务负责发送

> - 前端: web2、web3交互网关，所有web2服务以及web3 dapp入口

## 特性

### 关联验证(链下关联验证路径生成 + 链下签名生成 + 链上动态验证):

1. 实现目的: 强制性在链上验证关联动态授权的有效性, 只有所有签名验证通过才能在链上完成敏感操作, 同时通过默克尔树验证叶子结点有效性防止重放攻击
2. 实现方式: web2服务针对链上动态验证进行默克尔树管理, 并动态生成签名进行担保, wasm部分通过私有密钥生成随机数和签名保证私有操作, web3合约负责验证所有签名和默克尔树叶子结点的重复性
3. 实现原理: web2服务和wasm部分别生成动态随机数, 加入已有的默克尔树后生成相应证明, 同时两部分分别使用各自的私钥对随机数进行签名, 所有参数打包后送进合约进行签名验证和随机数有效性验证
4. 重放攻击: 为了防止重放攻击, 随机数全部在wasm部分生成, 并在每一次验证时都进行递增, 同时在web3合约中验证叶子结点是否有效以证明是否重复验证，验证通过后重新构建默克尔树并更新根节点hash值

### web3私有化(selfWeb3)

1. 强制将web3链上操作权绑定到用户自己，web3数据所有权真正归用户自己所有

2. 通过webAuthn、TOTP和邮箱校验等方式 以及由链下生成链上校验的关联验证机制为强制性提高保障

3. 由于私有动态授权的强制性绑定，钱包仅作为工具与web3合约交互，但默认也支持链下请求签名并由链上合约进行校验, 支持私有动态授权后重新绑定钱包

### 用户数据所有权私有化(web3合约)

1. 合约负责存储用于动态授权校验的密钥密文，包括恢复ID签名(web3私钥签署，web3私钥丢弃), web3密钥密文(dhKey加密), web3公钥密文(web2公钥加密)

2. 负责动态校验用户身份以及操作合法性进行确权，包括钱包签名验证, wasm签名验证, web2服务签名验证等

3. 负责提供具体的web3业务, 包括私有金库、私有NFT集以及用户其他web3数据等

### 隐私安全计算(WebAssembly)

1. wasm部分作为隐私安全计算节点，负责处理所有明文计算任务以及动态校验逻辑，同时所有操作依赖于支持自行重置的web2服务密钥，用于支持用户数据隐私安全

2. wasm文件合法性由链上合约进行保证，包括wasm部分明文存储文件hash值以及对应的签名, 部署时提供wasm地址, 以及在加载时请求链上合约校验签名的合法性

3. webAuthn数据由wasm部分采用随机密钥加密存储，随机密钥解密依赖于链上的web3密钥，该密钥提取需要通过TOTP动态授权以及关联验证

4. web2服务与wasm部分采用临时非对称ecdsa密钥对计算共享密钥的形式进行点对点加密通讯

### 零信任web2服务

1. 核心代码开源，支持服务私有部署

2. 为了保证高强度安全性，仅提供针对密文相关的的无状态服务，没有会话

3. 仅作为中心化节点提升用户体验, 用户密文数据存储到IPFS后，同时存储到web2服务用于快速检索

4. 作为零信任中心化服务，提供web2请求转发(比如邮件发送), 授权关联性管理以及加密数据存储和提取等定向增值服务

## 私有化动态授权

> - web3 SSO: 由Sismo Connect提供支持, 不参与关联验证, 由链下生成零知识证明链上验证用户身份合法性

> - WebAuthn: 由web2服务和ceramic store提供凭证密文支持, 参与关联验证, 由链上验证动态授权有效性

> - Email: 由wasm负责缓存动态验证码并完成验证, web2服务负责发送, 参与关联验证, 由链上验证动态授权有效性

> - TOTP: 由wasm部分解密出web3公钥，计算和解密出TOTP密钥后进行动态校验, 参与关联验证, 由链上验证动态授权有效性

## 关联验证流程

> - 部署流程: web2服务生成公私钥, 部署web3合约并提供web2服务地址

> - 注册流程: wasm部分初始化随机数以及步长 -> web请求web2服务进行默克尔树初始化

> - dapp操作(链上查询): web开始动态授权流程 -> wasm部分完成动态验证 -> wasm部分加密随机数并签名 -> web请求web2服务进行签名(可选) -> web请求链上合约验证签名 -> wasm部分获取到密文采用私有密钥解密 -> wasm部分解密并进行链下数据匹配验证

> - dapp操作(链上更新): web开始动态授权流程 -> wasm部分完成动态验证 -> wasm部分生成随机数并进行签名 -> web请求web2服务获取签名和默克尔树证明 -> web请求链上合约验证签名和证明 -> 合约验证所有签名是否合法, 再通过默克尔树验证随机数是否合法 -> 验证成功, 更新默克尔树的哈希 -> 更新合约状态

> - 流程说明: 如果开启web3模式, 由于没有web2服务的支持, 无法获取到动态签名, 为了保证链上敏感操作的高度安全, web3合约会针对链上更新的操作强制性验证两部分的签名以及默克尔树叶子节点的有效性, 之所引入web2服务的签名验证, 是为了通过web2服务和wasm两部分的签名加强关联验证的安全性, 同时只有wasm部分才能获取到用户私有密钥和数据, 通过生成动态随机数并签名的形式防止关联验证的非法通过

## 核心业务流程

> - 支持通过钱包签名, 私有动态授权, 关联验证等所有动态验证后, 进行私有化的web3业务流程操作

### web2模式

1. 初始化流程需要首先完成web2服务在链上合约的签名验证以及wasm文件的解密, 否则无法查询和更新合约内的任何数据

2. 支持向web3合约和web2服务进行数据读写，私有动态授权流程需要关联验证通过，即web3 SSO -> email -> TOTP -> webAuthn

3. web2服务密钥是由后端web2服务生成的随机密钥，同时支持自行输入32位字符串作为web2服务密钥，但每次加载web都需要输入

4. web3公钥由web2公钥加密后存储在web3合约中, 用于与web2私钥钥动态计算合成dhKey, 一经注册写入合约无法更改

5. web3密钥由dhKey加密后存储在web3合约中，用于用户数据加密后存储到IPFS和web2服务，比如webAuthn相关数据

6. web2私钥由wasm部分随机生成，用于与web3公钥动态计算合成dhKey, 由web2服务密钥加密并抄送到用户邮箱

7. 重置功能包括TOTP, web2服务密钥以及用户钱包，所有重置操作都会启用完整的关联验证流程用于加强安全防护

8. dapp业务，所有需要写入web3合约的相关操作都需要TOTP和webAuthn动态校验，敏感操作将触发邮件校验

### web3模式

1. 初始化流程需要首先完成web2服务在链上合约的签名验证以及wasm文件的解密, 否则无法查询和更新合约内的任何数据

2. 支持向web3合约和ceramic store进行数据读写，私有动态授权流程需要关联验证通过，即web3 SSO -> TOTP -> webAuthn

3. web2服务仅仅作为中心化节点提升用户体验, 如果用户选择不使用或者服务故障, 用户密文将从ceramic stor提取

4. 由于没有web2服务的支持, 需要自行输入web2私钥密文以及web2服务密钥(如果自行指定重置过web2服务密钥)

5. 由于没有web2服务的支持, 暂时邮件校验功能将受限, 但不影响web3业务的正常操作

6. 不支持注册, 用于敏感操作的关联验证, 以及所有恢复重置功能

### 私有部署

```shell
git clone https://github.com/refitor/selfweb3.git

cd selfweb3

chmod +x ./build.sh

./build.sh
```

### 使用

```
./selfweb3
```

[1]: /docs/README-zh.md