# selfweb3

[简体中文][1]

### 一种为链上高度安全和数据所有权提供私有化保障的web3解决方案，通过强制动态授权，将用户资产一对一绑定到自己，而非钱包，零知识证明 + webAuthn + TOTP + 关联验证

![/docs/selfweb3.png](/docs/selfweb3.png)

## 合约

1. **Arbitrum Goerli, 421613: 0x7B6E05a55B1756f827F205BF454BF75288904ecF**

## 系统架构

![/docs/selfweb3-arch.png](/docs/selfweb3-arch.png)

#### 说明: 公私钥指椭圆曲线secp256k1生成的公私钥对，密钥指32位明文字符串，dhKey指通过私钥和公钥动态计算出来的共享密钥

> - 合约: 去中心化存储，一经注册写入，无法更改，支持钱包重新绑定，依赖于用户私有动态授权，而非钱包公私钥

> - wasm: 提供密钥合成、TOTP校验和邮件校验服务，支持关联验证机制的链下实现，所有操作需要依赖web2密文已解密

> - 后端: web2服务, 仅提供邮件发送以及加密数据存储和提取等定向增值服务, 无会话，无状态，仅处理密文数据

> - TOTP: 由web2服务提供TOTP密钥密文，以及wasm部分解密出web3公钥，计算和解密出TOTP密钥后进行动态校验

> - 邮件: 由wasm负责缓存动态验证码并完成验证, web2服务负责发送

> - 前端: web2、web3交互网关，所有web2服务以及web3 dapp入口

## 特性

### 关联验证(链下证明生成 + 链上动态验证): 

1. 实现原理: 合约提供关联验证的基础leaf数据，以及merkle树验证入口, 链下负责根据具体场景动态生成merkle树以及相应的证明, 验证根据固定规则校验链下动态授权的有效性
2. 实现目的: 强制性在链上验证动态授权的有效性, 只有验证通过才能成功获取到链上存储的密文数据
3. 实现方式: 合约仅提供基础随机数, 由外部动态生成merkle树, 既保证链上验证也支持灵活扩展

### web3私有化(selfWeb3)

1. 强制将web3链上操作权绑定到用户自己，web3数据所有权真正归用户自己所有

2. 通过webAuthn、TOTP和邮箱校验等方式 以及由链下生成链上校验的关联验证机制为强制性提高保障

3. 由于私有动态授权的强制性绑定，钱包仅作为工具与web3合约交互，但默认也支持链下请求签名并由链上合约进行校验, 支持私有动态授权后重新绑定钱包

### 用户数据所有权私有化(web3合约)

1. 合约负责存储用于动态授权校验的密钥密文，包括恢复ID签名(web3私钥签署，web3私钥丢弃), web3密钥密文(dhKey加密), web3公钥密文(web2公钥加密)

2. 负责动态校验用户身份以及操作合法性进行确权，包括钱包签名校验和关联验证链上校验

3. 负责提供具体的web3业务, 包括私有金库、私有NFT集以及用户其他web3数据等

### 隐私安全计算(WebAssembly)

1. wasm部分作为隐私安全计算节点，负责处理所有明文计算任务以及动态校验逻辑，同时所有操作依赖于支持自行重置的web2服务密钥，用于支持用户数据隐私安全

2. wasm文件合法性暂时由官方保证，支持由web2服务以及web3合约协作完成动态校验，包括链下文件合法性证明生成以及链上动态验证

3. webAuthn数据由wasm部分采用随机密钥加密存储，随机密钥解密依赖于链上的web3密钥，该密钥提取需要通过链上动态校验

4. web2服务与wasm部分采用临时非对称ecdsa密钥对计算共享密钥的形式进行点对点加密通讯

### 零信任web2服务

1. 核心代码开源，支持服务私有部署

2. 为了保证高强度安全性，仅提供针对密文相关的的无状态服务，没有会话

3. 仅作为中心化节点提升用户体验, 用户密文数据存储到IPFS后，同时存储到web2服务用于快速检索

4. 作为零信任中心化服务，仅提供web2相关密文数据存储提取，以及基于用户密文的定向业务增值服务

## 私有化动态授权

> - web3 SSO: 由Sismo Connect提供支持, 不参与关联验证, 由链下生成零知识证明链上验证用户身份合法性

> - WebAuthn: 由web2服务和ceramic store提供凭证密文支持, 参与关联验证, 由链上验证动态授权有效性

> - Social Email: 由wasm负责缓存动态验证码并完成验证, web2服务负责发送, 参与关联验证, 由链上验证动态授权有效性

> - TOTP: 由wasm部分解密出web3公钥，计算和解密出TOTP密钥后进行动态校验, 参与关联验证, 由链上验证动态授权有效性

## 关联验证流程

> - 合约: verifyRandom(用于关联验证的随机数, 仅在注册时写入无法修改, 将作为leaf参与merkle树验证)
> - 注册: 生成用于关联验证的随机数, 写入合约, 通过web2Key加密存入web2服务，同时备份存储到ceramic storage
> - 验证: wasm部分根据解密出的verifyRandom, 遵循 email + step + 1, TOTP + step + 2, webAuthn + step + 3的规则生成证明和merkle树的root, 合约根据传入的proof, root, step以及存储的verifyRandom进行merkle树验证

## 核心业务流程

> - 支持通过钱包签名, 私有动态授权, 关联验证的所有动态校验后, 进行私有化的web3业务流程操作

### web2模式

1. 支持向web3合约和web2服务进行数据读写，私有动态授权流程需要关联验证通过，即web3 SSO -> email -> TOTP -> webAuthn

2. web2服务密钥是由后端web2服务生成的随机密钥，同时支持自行输入32位字符串作为web2服务密钥，但每次加载web都需要输入

3. web3公钥由web2公钥加密后存储在web3合约中, 用于与web2私钥钥动态计算合成dhKey, 一经注册写入合约无法更改

4. web3密钥由dhKey加密后存储在web3合约中，用于用户数据加密后存储到IPFS和web2服务，比如webAuthn相关数据

5. web2私钥由wasm部分随机生成，用于与web3公钥动态计算合成dhKey, 由web2服务密钥加密并抄送到用户邮箱

6. 重置功能包括TOTP, web2服务密钥以及用户钱包，所有重置操作都会启用完整的关联验证流程用于加强安全防护

7. dapp业务，所有需要写入web3合约的相关操作都需要TOTP和webAuthn动态校验，敏感操作将触发邮件校验

### web3模式

1. 支持向web3合约和ceramic store进行数据读写，私有动态授权流程需要关联验证通过，即web3 SSO -> TOTP -> webAuthn

2. web2服务仅仅作为中心化节点提升用户体验, 如果用户选择不使用或者服务故障, 用户密文将从ceramic stor提取

3. 由于没有web2服务的支持, 需要自行输入web2私钥密文以及可选的web2服务密钥(如果自行指定重置过web2服务密钥)

4. 由于没有web2服务的支持, 暂时邮件校验功能将受限, 但不影响web3业务的正常操作

5. 不支持注册和所有恢复重置功能, 仅支持除邮件校验外的关联验证

### 私有部署

```shell
git clone https://github.com/refitor/selfweb3.git

cd selfweb3

chmod +x ./build.sh

./build.sh
```

### 使用

```
./selfweb3
```

[1]: /docs/README-zh.md