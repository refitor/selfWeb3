# selfweb3

[简体中文][1]

### 一种将Web3与用户自己一对一绑定的链上私有化解决方案，链下动态授权(Email + TOTP + WebAuthn) + 多方签名担保 + 链上强制验证

![/docs/selfweb3.png](/docs/selfweb3.png)

## 合约

1. **Arbitrum Goerli, 421613: 0xec04F8Ee0493f3d763AB1624BB6aAcaCD94Ac4C1**

## 安全模型: [https://refitself.medium.com/a-privatized-web3-security-model-selfweb3-209439c5d8e2][2]

## 系统架构

### 原则: 链下完成动态授权后, 由相互不可见的多方签名担保，向链上证明用户身份的合法性，各方相互制约，保证去中心化运作的同时，提供高度安全的隐私保护

![/docs/selfweb3-arch.png](/docs/selfweb3-arch.png)

#### 说明: 公私钥指椭圆曲线secp256k1算法生成的公私钥对，密钥指32位明文字符串，dhKey指通过私钥和公钥动态计算出来的共享密钥

> - web3合约: 私有密钥防篡改提供保障，链上数据获取和更新依赖于用户私有动态授权以及链上强制性的关联验证

> - wasm计算: 作为隐私计算节点，处理私有密钥和私有数据相关的所有明文计算任务, 以及私有动态授权的链下校验 

> - web2服务: 作为担保方为关联验证提供背书, 支持请求转发, 密文数据存储等服务, 无会话，无状态，仅处理密文数据

> - web3存储: 作为存储节点为用户私有签名提供支持, 链上验证依赖多方存储提供的数据生成签名, 各自不可见相互制约

> - 动态授权: 作为证明用户身份的链下实现, 包括Email, TOTP, WebAuthn等, 通过关联验证在链上合约进行验证确权

> - 关联验证: 作为证明机制保证私有动态授权的有效性, 包括链下关联性校验，多方签名动态生成，以及默克尔树证明生成

> - 链上验证: 作为证明机制保证链上操作的合法性, 包括链上多方签名验证和默克尔树重放攻击验证

> - web前端: web2、web3交互网关，所有web2服务以及web3 dapp入口

## 混合存储架构

### web2中心化服务: 私有密钥加密后存储
> - web2Key: 用于web2服务数据加密存储的统一密钥, 不对外
> - web2Nonce: web2服务自身的随机数, 与私有随机数协作, 不对外
> - web2Data: 为用户提供私有数据密文备份存储服务, 提升用户体验, 由wasm处理
> - web2Private: web2服务自身的私钥, 用于生成web2签名以及动态合成web2DHKey, 不对外

### web3合约存储: 私有密钥 + 钱包加密后存储
> - web2地址: 用于验证web2服务签名
> - recoverID: web3私钥签名 + 钱包签名验证
> - selfKey: web2DHKey加密 + 钱包加密 + 钱包签名验证
> - selfPrivate: selfKey加密 + selfPass加密 + 钱包签名验证
   
### 私有数据存储: selfKey加密后存储 => web2 + web3
> - TOTPKey: 用于TOTP验证, selfDHKey加密
> - selfNonce: 私有的随机数, 与web2随机数协作
> - web3Public: 用于生成私有地址以及动态合成web2DHKey和selfDHKey, web3私钥丢弃
> - web2DHKey: 由web2私钥和web3公钥动态计算生成的共享密钥, 作为用户在web2服务的密钥, 同时用于加密selfKey

## 安全模型: 混合加密 + 私有动态授权 + 关联验证

### 混合加密

> - 实现目的: 保证私有密钥在多方加密的保护下高度安全，用于针对私有数据在web2中心化或者web3去中心化环境中安全存储
> - 实现原理: 先通过web2共享密钥web2DHKey加密再由用户钱包加密, web2DHKey加密是为了防止在用户钱包被盗的情况下，私有密钥依旧安全, 钱包再次加密是为了零信任web2服务防止篡改私有密钥  

## 私有动态授权

> - Wallet: 由钱包私钥进行签名并在web3合约内通过验证

> - TOTP: 由wasm部分负责动态计算出selfDHKey后进行动态验证, 参与关联验证, 由链上验证动态授权有效性

> - Email: 由wasm负责缓存动态验证码并完成验证, web2服务负责发送, 参与关联验证, 由链上验证动态授权有效性

> - WebAuthn: 由wasm部分负责动态计算出selfDHKey后解密WehAuthn凭证密文, 参与关联验证, 由链上验证动态授权有效性

### 关联验证(链下签名生成 + 链下默克尔树证明生成 + 链上动态验证):

> - 实现目的: 强制性在链上验证关联动态授权的有效性, 只有所有签名验证通过才能在链上完成敏感操作, 同时通过默克尔树验证叶子结点有效性防止重放攻击
> - 实现原理: web2服务和wasm部分别生成动态随机数, 加入已有的默克尔树后生成相应证明, 同时两部分分别使用各自的私钥对随机数进行签名, 所有参数打包后送进合约进行签名验证和随机数有效性验证
> - 实现方式: web2服务针对链上动态验证进行默克尔树管理, 并动态生成签名进行担保, wasm部分通过self私钥生成签名和随机数保证私有操作, web3合约负责验证所有签名和默克尔树证明的有效性
> - 重放攻击: 为了防止签名泄漏导致重放攻击, 仅针对链上更新操作验证签名和默克尔树证明, 在web3合约中验证叶子结点是否有效以证明是否重复验证，验证通过后重新构建默克尔树根节点hash值

## 特性

### web3私有化(selfWeb3)

1. 强制将web3链上操作权绑定到用户自己，web3数据所有权真正归用户自己所有

2. 通过webAuthn、TOTP和邮箱校验等方式以及由链下生成证明链上校验的关联验证机制为强制性提高保障

3. 由于私有动态授权的强制性绑定，钱包仅作为工具与web3合约交互, 支持私有动态授权后重新绑定钱包

### 用户数据所有权私有化(web3合约)

1. 合约负责存储用于动态授权校验的密钥密文，由区块链提供防篡改的安全性保障, 后续支持多链

2. 负责针对用户身份以及操作合法性进行动态验证确权，包括钱包签名验证, 私有签名验证, web2服务签名验证等

3. 负责提供具体的web3业务, 包括私有金库、私有NFT集以及用户其他web3数据等

### 隐私安全计算(WebAssembly)

1. 作为隐私计算节点，处理私有密钥和私有数据相关的所有明文计算任务, 以及私有动态授权的链下校验，同时所有操作依赖于私有数据的成功解密，用于支持用户数据隐私安全

2. wasm文件合法性由动态计算的文件hash值并由链上合约动态验证合法性进行保证，同时仅缓存密文数据用于支持运行时的计算和授权校验任务

3. webAuthn授权暂时由web2服务提供支持, 但web2服务可以通过源码自行编译部署, 后续将针对web3去中心化运行进行优化升级

4. web2服务与wasm部分采用临时非对称ecdsa密钥对计算共享密钥的形式进行点对点加密通讯

### web2服务

1. 为了保证作为担保方的私密性, 仅部分代码开源，支持服务私有部署

2. 为了保证高强度安全性，仅提供针对密文相关的的无状态服务，没有会话

3. 仅作为中心化节点提升用户体验, 用户密文数据存储到web3去中心化平台后，同时存储到web2服务用于快速检索

4. 作为零信任中心化服务，提供web2请求转发(比如邮件发送), 授权关联性验证和管理以及加密数据存储和提取等定向增值服务

## 关联验证流程

> - 部署流程: web2服务生成公私钥, 部署web3合约并提供web2服务地址

> - 动态授权(链下验证): web开始动态授权流程 -> wasm部分完成动态验证 -> wasm部分生成随机数并进行签名

> - 关联验证(web2验证): web请求web2服务获取签名和默克尔树证明 -> web2服务完成动态授权的关联性验证 -> web2服务签名并生成默克尔树证明 

> - 关联验证(链上验证): web请求链上合约验证签名和证明 -> 合约验证所有签名是否合法, 再通过默克尔树验证随机数是否合法 -> 验证成功, 更新默克尔树的根哈希 -> 更新合约状态

> - 流程说明: 如果开启web3模式, 由于没有web2服务的支持, 无法获取到动态签名, 为了保证非必需的web2服务依赖, web3合约会针对链上更新操作强制性验证多方签名以及默克尔树叶子节点的有效性, 但优先支持钱包签名验证和单一的私有签名验证, 之所引入web2服务的签名担保, 是为了通过web2服务和用户自己私有的签名加强关联验证的安全性, 同时只有wasm部分才能获取到用户私有密钥和数据, 通过生成动态随机数并签名的形式防止关联验证非法通过

## 核心业务流程

> - 支持通过钱包签名, 私有动态授权, 关联验证等所有动态验证后, 进行私有化的web3业务流程操作

### web2模式

1. 初始化流程需要首先完成web2服务在链上合约的签名验证以及wasm文件的合法性验证, 否则无法查询和更新合约内的任何数据

2. 支持向web3合约和web2服务进行数据读写，私有动态授权流程需要关联验证通过，即wallet -> email -> TOTP -> webAuthn

4. web3公钥在随机生成并在对恢复ID签名后丢弃私钥, 用于生成私有地址以及参与共享密钥的计算, 经加密后存储到web2服务和web3去中心化存储平台

4. self私钥由selfKey和selfPass加密后存储在web3合约中, 与web3公钥动态计算合成selfDHKey后作为用户私有的密钥解密私有数据

5. selfKey由web2DHKey和用户钱包关联加密后存储在web3合约中，用于私有数据加密后存储到web2服务和web3去中心化存储平台，比如TOTPKey, webAuthn凭证等私有数据

6. 重置功能包括TOTP, WebAuthn, SelfPass以及用户钱包等，所有重置操作都会启用完整的关联验证流程用于加强安全防护, 同时TOTP和WebAuthn重置需要其中的一个有效, 否则需要通过除Email校验外的的审核验证

7. dapp业务，所有需要写入web3合约的相关操作都需要TOTP和webAuthn动态校验，敏感操作将触发邮件校验

### web3模式

1. 初始化流程需要首先完成wasm文件的合法性验证, 否则无法查询和更新合约内的任何数据

2. 支持向web3合约进行数据读写，私有动态授权流程需要链上验证通过，即wallet -> TOTP -> webAuthn

3. web2服务作为担保方为关联验证背书的同时提供定向增值服务, 如果用户选择不使用或者服务故障, 用户密文数据将从web3去中心化平台获取

4. 由于没有web2服务的支持, 无法获取到动态签名, 只有单一的私有签名为动态授权提供担保，链上验证将仅支持验证由self私钥签署的动态签名

5. 由于没有web2服务的支持, 无法获取到默克尔树关联验证证明, 支持由用户自行选择是否在没有关联验证的前提下开启链上敏感操作(不推荐, 极其危险!!!)

6. 由于没有web2服务的支持, 暂时邮件校验功能将受限, 但不影响web3业务的正常操作

7. 不支持注册, 用于敏感操作的关联验证, 以及所有恢复重置功能

### 私有部署

```shell
git clone https://github.com/refitor/selfweb3.git

cd selfweb3

chmod +x ./build.sh

./build.sh
```

### 使用

```
./selfweb3
```

[1]: /docs/selfweb3-arch-zh.md
[2]: https://refitself.medium.com/a-privatized-web3-security-model-selfweb3-209439c5d8e2